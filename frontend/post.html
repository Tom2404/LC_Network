<!DOCTYPE html>
<html class="light" lang="vi">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Bài viết | LC Network</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#18a058",
                    }
                }
            }
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        
        .material-symbols-outlined-filled {
            font-family: 'Material Symbols Outlined';
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        body {
            font-family: 'Manrope', sans-serif;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
</head>

<body class="bg-[#e8f1f0] dark:bg-[#0d1918] text-[#101818] dark:text-white transition-colors duration-200">
    <!-- Header -->
    <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-[#dae7e6] dark:border-[#2a3d3b] bg-white dark:bg-[#152a28] px-6 lg:px-10 py-3 sticky top-0 z-50">
        <div class="flex items-center gap-8">
            <button onclick="window.history.back()" class="text-[#101818] dark:text-white hover:text-primary transition-colors">
                <span class="material-symbols-outlined text-2xl">arrow_back</span>
            </button>
            <div class="flex items-center gap-4 text-primary">
                <div class="size-8">
                    <svg fill="none" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13.8261 30.5736C16.7203 29.8826 20.2244 29.4783 24 29.4783C27.7756 29.4783 31.2797 29.8826 34.1739 30.5736C36.9144 31.2278 39.9967 32.7669 41.3563 33.8352L24.8486 7.36089C24.4571 6.73303 23.5429 6.73303 23.1514 7.36089L6.64374 33.8352C8.00331 32.7669 11.0856 31.2278 13.8261 30.5736Z" fill="currentColor"></path>
                        <path clip-rule="evenodd" d="M39.998 35.764C39.9944 35.7463 39.9875 35.7155 39.9748 35.6706C39.9436 35.5601 39.8949 35.4259 39.8346 35.2825C39.8168 35.2403 39.7989 35.1993 39.7813 35.1602C38.5103 34.2887 35.9788 33.0607 33.7095 32.5189C30.9875 31.8691 27.6413 31.4783 24 31.4783C20.3587 31.4783 17.0125 31.8691 14.2905 32.5189C12.0012 33.0654 9.44505 34.3104 8.18538 35.1832C8.17384 35.2075 8.16216 35.233 8.15052 35.2592C8.09919 35.3751 8.05721 35.4886 8.02977 35.589C8.00356 35.6848 8.00039 35.7333 8.00004 35.7388C8.00004 35.739 8 35.7393 8.00004 35.7388C8.00004 35.7641 8.0104 36.0767 8.68485 36.6314C9.34546 37.1746 10.4222 37.7531 11.9291 38.2772C14.9242 39.319 19.1919 40 24 40C28.8081 40 33.0758 39.319 36.0709 38.2772C37.5778 37.7531 38.6545 37.1746 39.3151 36.6314C39.9006 36.1499 39.9857 35.8511 39.998 35.764ZM4.95178 32.7688L21.4543 6.30267C22.6288 4.4191 25.3712 4.41909 26.5457 6.30267L43.0534 32.777C43.0709 32.8052 43.0878 32.8338 43.104 32.8629L41.3563 33.8352C43.104 32.8629 43.1038 32.8626 43.104 32.8629L43.1051 32.865L43.1065 32.8675L43.1101 32.8739L43.1199 32.8918C43.1276 32.906 43.1377 32.9246 43.1497 32.9473C43.1738 32.9925 43.2062 33.0545 43.244 33.1299C43.319 33.2792 43.4196 33.489 43.5217 33.7317C43.6901 34.1321 44 34.9311 44 35.7391C44 37.4427 43.003 38.7775 41.8558 39.7209C40.6947 40.6757 39.1354 41.4464 37.385 42.0552C33.8654 43.2794 29.133 44 24 44C18.867 44 14.1346 43.2794 10.615 42.0552C8.86463 41.4464 7.30529 40.6757 6.14419 39.7209C4.99695 38.7775 3.99999 37.4427 3.99999 35.7391C3.99999 34.8725 4.29264 34.0922 4.49321 33.6393C4.60375 33.3898 4.71348 33.1804 4.79687 33.0311C4.83898 32.9556 4.87547 32.8935 4.9035 32.8471C4.91754 32.8238 4.92954 32.8043 4.93916 32.7889L4.94662 32.777L4.95178 32.7688ZM35.9868 29.004L24 9.77997L12.0131 29.004C12.4661 28.8609 12.9179 28.7342 13.3617 28.6282C16.4281 27.8961 20.0901 27.4783 24 27.4783C27.9099 27.4783 31.5719 27.8961 34.6383 28.6282C35.082 28.7342 35.5339 28.8609 35.9868 29.004Z" fill="currentColor" fill-rule="evenodd"></path>
                    </svg>
                </div>
                <h2 class="text-xl font-bold leading-tight tracking-tight dark:text-white">LC Network</h2>
            </div>
            <label class="flex flex-col min-w-40 !h-10 max-w-md">
                <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
                    <div class="text-[#5e8d89] flex border-none bg-[#f0f5f4] dark:bg-[#1a3330] items-center justify-center pl-4 rounded-l-lg border-r-0">
                        <span class="material-symbols-outlined text-xl">search</span>
                    </div>
                    <input class="form-input flex w-full min-w-0 flex-1 border-none bg-[#f0f5f4] dark:bg-[#1a3330] focus:outline-0 focus:ring-0 text-[#101818] dark:text-white placeholder:text-[#5e8d89] px-4 rounded-r-lg pl-2 text-base font-normal" placeholder="Tìm kiếm bài viết hoặc bạn bè..." value="" />
                </div>
            </label>
        </div>
        <div class="flex flex-1 justify-end gap-6">
            <div class="flex gap-2">
                <a href="index.html" class="flex items-center justify-center rounded-lg h-10 w-10 bg-[#f0f5f4] dark:bg-[#1a3330] text-[#101818] dark:text-white hover:bg-[#dae7e6] dark:hover:bg-[#2a3d3b] transition-colors">
                    <span class="material-symbols-outlined">home</span>
                </a>
                <a href="friends.html" class="flex items-center justify-center rounded-lg h-10 w-10 bg-[#f0f5f4] dark:bg-[#1a3330] text-[#101818] dark:text-white hover:bg-[#dae7e6] dark:hover:bg-[#2a3d3b] transition-colors">
                    <span class="material-symbols-outlined">group</span>
                </a>
                <a href="notifications.html" class="flex items-center justify-center rounded-lg h-10 w-10 bg-[#f0f5f4] dark:bg-[#1a3330] text-[#101818] dark:text-white hover:bg-[#dae7e6] dark:hover:bg-[#2a3d3b] transition-colors">
                    <span class="material-symbols-outlined">notifications</span>
                </a>
            </div>
            <div class="relative">
                <div id="headerAvatar" class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border-2 border-primary cursor-pointer" onclick="window.location.href='profile.html'" style="background-image: url('images/default-avatar.png');">
                </div>
                <div class="absolute bottom-0 right-0 size-3 bg-green-500 rounded-full border-2 border-white dark:border-[#152a28]"></div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex justify-center py-6 px-4 md:px-8">
        <div class="w-full max-w-4xl">
            <!-- Post Card -->
            <div id="postContainer" class="bg-white dark:bg-[#152a28] rounded-xl shadow-sm border border-[#dae7e6] dark:border-[#2a3d3b] overflow-hidden">
                <!-- Loading State -->
                <div id="loadingState" class="flex items-center justify-center py-20">
                    <div class="text-center">
                        <span class="material-symbols-outlined text-5xl text-[#5e8d89] animate-spin">progress_activity</span>
                        <p class="mt-4 text-[#5e8d89]">Đang tải bài viết...</p>
                    </div>
                </div>

                <!-- Post Content (will be filled by JS) -->
                <div id="postContent" class="hidden">
                    <!-- Post Header -->
                    <div class="p-4 flex items-center justify-between border-b border-[#dae7e6] dark:border-[#2a3d3b]">
                        <div class="flex items-center gap-3">
                            <img id="postAuthorAvatar" src="images/default-avatar.png" class="size-12 rounded-full border-2 border-[#dae7e6] object-cover" onerror="this.src='images/default-avatar.png'" />
                            <div>
                                <h3 id="postAuthorName" class="text-[#101818] dark:text-white font-bold text-base">Đang tải...</h3>
                                <p id="postTime" class="text-[#5e8d89] dark:text-[#8faeaa] text-sm">Vừa xong</p>
                            </div>
                        </div>
                    </div>

                    <!-- Post Text Content -->
                    <div id="postTextContent" class="p-4 text-[#101818] dark:text-white text-base leading-relaxed whitespace-pre-wrap"></div>

                    <!-- Post Media -->
                    <div id="postMediaContainer" class="hidden">
                        <img id="postImage" class="w-full object-cover max-h-[600px] hidden cursor-pointer" onclick="openImageModal(this.src)" />
                        <video id="postVideo" class="w-full object-cover max-h-[600px] hidden" controls></video>
                    </div>

                    <!-- Post Stats and Actions -->
                    <div class="px-4 py-3 border-t border-[#dae7e6] dark:border-[#2a3d3b]">
                        <div class="flex items-center justify-between text-sm text-[#5e8d89] dark:text-[#8faeaa] mb-3">
                            <span id="likeCount">0 lượt thích</span>
                            <span id="commentCount">0 bình luận</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="likeButton" onclick="toggleLike()" class="flex-1 flex items-center justify-center gap-2 py-2 rounded-lg hover:bg-[#e8f1f0] dark:hover:bg-[#2a3d3b] transition-colors text-[#5e8d89] dark:text-[#8faeaa]">
                                <span class="material-symbols-outlined">favorite_border</span>
                                <span class="font-medium">Thích</span>
                            </button>
                            <button onclick="document.getElementById('commentInput').focus()" class="flex-1 flex items-center justify-center gap-2 py-2 rounded-lg hover:bg-[#e8f1f0] dark:hover:bg-[#2a3d3b] transition-colors text-[#5e8d89] dark:text-[#8faeaa]">
                                <span class="material-symbols-outlined">chat_bubble_outline</span>
                                <span class="font-medium">Bình luận</span>
                            </button>
                        </div>
                    </div>

                    <!-- Comments Section -->
                    <div class="border-t border-[#dae7e6] dark:border-[#2a3d3b]">
                        <!-- Comment Input -->
                        <div class="p-4 border-b border-[#dae7e6] dark:border-[#2a3d3b]">
                            <div class="flex items-start gap-3">
                                <div id="currentUserAvatar" class="size-10 rounded-full bg-cover bg-center border-2 border-[#dae7e6] shrink-0" style="background-image: url('images/default-avatar.png');"></div>
                                <div class="flex-1">
                                    <textarea id="commentInput" placeholder="Viết bình luận..." class="w-full px-4 py-2 rounded-lg border border-[#dae7e6] dark:border-[#2a3d3b] bg-white dark:bg-[#152a28] text-[#101818] dark:text-white placeholder:text-[#5e8d89] focus:outline-none focus:border-primary resize-none" rows="2"></textarea>
                                    <div class="flex items-center justify-between mt-2">
                                        <div class="flex items-center gap-2">
                                            <label class="cursor-pointer p-2 rounded-lg hover:bg-[#e8f1f0] dark:hover:bg-[#2a3d3b] transition-colors text-[#5e8d89]">
                                                <span class="material-symbols-outlined">image</span>
                                                <input type="file" id="commentMediaInput" accept="image/*,video/*" class="hidden" onchange="handleCommentMedia(event)" />
                                            </label>
                                        </div>
                                        <button onclick="submitComment()" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors font-medium">
                                            Gửi
                                        </button>
                                    </div>
                                    <div id="commentMediaPreview" class="mt-2 hidden relative">
                                        <img id="commentMediaImg" class="max-h-32 rounded-lg border border-[#dae7e6]" />
                                        <button onclick="removeCommentMedia()" class="absolute top-2 right-2 bg-black/50 text-white rounded-full p-1 hover:bg-black/70">
                                            <span class="material-symbols-outlined text-xl">close</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Comments List -->
                        <div id="commentsList" class="max-h-[600px] overflow-y-auto custom-scrollbar">
                            <div class="p-8 text-center text-[#5e8d89]">
                                <span class="material-symbols-outlined text-5xl">chat_bubble_outline</span>
                                <p class="mt-2">Chưa có bình luận nào</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Image Modal -->
    <div id="imageModal" class="fixed inset-0 z-[9999] hidden">
        <div class="absolute inset-0 bg-black/90" onclick="closeImageModal()"></div>
        <button onclick="closeImageModal()" class="absolute top-4 right-4 z-10 bg-white/10 hover:bg-white/20 backdrop-blur-sm text-white rounded-full p-3 transition-all">
            <span class="material-symbols-outlined text-2xl">close</span>
        </button>
        <div class="relative z-10 flex items-center justify-center h-full p-8 cursor-pointer" onclick="closeImageModal()">
            <img id="modalImage" src="" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl cursor-default" onclick="event.stopPropagation()">
        </div>
    </div>

    <script>
        let currentPostId = null;
        let currentPost = null;
        let commentMediaFile = null;

        // Get post ID from URL
        function getPostIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Get time ago string
        function getTimeAgo(dateString) {
            if (!dateString) {
                console.error('getTimeAgo: dateString is undefined or null');
                return 'Không rõ thời gian';
            }
            
            console.log('getTimeAgo input:', dateString);
            const date = new Date(dateString);
            
            if (isNaN(date.getTime())) {
                console.error('getTimeAgo: Invalid date:', dateString);
                return 'Không rõ thời gian';
            }
            
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            console.log('Seconds ago:', seconds);
            
            if (seconds < 60) return 'Vừa xong';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} phút trước`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} giờ trước`;
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days} ngày trước`;
            const weeks = Math.floor(days / 7);
            if (weeks < 4) return `${weeks} tuần trước`;
            const months = Math.floor(days / 30);
            if (months < 12) return `${months} tháng trước`;
            const years = Math.floor(days / 365);
            return `${years} năm trước`;
        }

        // Load user avatar in header
        async function loadUserAvatar() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user.avatar_url) {
                const avatarUrl = `${API_URL}${user.avatar_url}`;
                document.getElementById('headerAvatar').style.backgroundImage = `url(${avatarUrl})`;
                const commentAvatar = document.getElementById('currentUserAvatar');
                if (commentAvatar) {
                    commentAvatar.style.backgroundImage = `url(${avatarUrl})`;
                }
            }
        }

        // Load post data
        async function loadPost(postId) {
            try {
                const response = await fetchWithAuth(`${API_URL}/posts/${postId}`);
                if (!response.ok) throw new Error('Không thể tải bài viết');
                
                const data = await response.json();
                console.log('=== RAW POST DATA FROM API ===');
                console.log(JSON.stringify(data, null, 2));
                console.log('=== END POST DATA ===');
                
                // Unwrap if API returns {post: {...}}
                currentPost = data.post || data;
                console.log('=== UNWRAPPED POST ===');
                console.log(JSON.stringify(currentPost, null, 2));
                
                renderPost(currentPost);
                
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('postContent').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading post:', error);
                document.getElementById('loadingState').innerHTML = `
                    <div class="text-center">
                        <span class="material-symbols-outlined text-5xl text-red-500">error</span>
                        <p class="mt-4 text-[#101818] dark:text-white font-medium">Không thể tải bài viết</p>
                        <button onclick="window.history.back()" class="mt-4 px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                            Quay lại
                        </button>
                    </div>
                `;
            }
        }

        // Render post
        function renderPost(post) {
            console.log('=== RENDERING POST ===');
            console.log('Post object keys:', Object.keys(post));
            console.log('Post.author:', post.author);
            console.log('Post.user:', post.user);
            console.log('Post.user_id:', post.user_id);
            console.log('Post.username:', post.username);
            console.log('Post.full_name:', post.full_name);
            console.log('Post.created_at:', post.created_at);
            
            // Try different possible data structures
            let authorName = 'Người dùng';
            let authorAvatar = 'images/default-avatar.png';
            
            // Check nested author object first
            if (post.author) {
                authorName = post.author.full_name || post.author.username || 'Người dùng';
                if (post.author.avatar_url) {
                    authorAvatar = post.author.avatar_url.startsWith('http') ? post.author.avatar_url : `${API_URL}${post.author.avatar_url}`;
                }
            } 
            // Check nested user object
            else if (post.user) {
                authorName = post.user.full_name || post.user.username || 'Người dùng';
                if (post.user.avatar_url) {
                    authorAvatar = post.user.avatar_url.startsWith('http') ? post.user.avatar_url : `${API_URL}${post.user.avatar_url}`;
                }
            }
            // Check flat structure
            else if (post.full_name || post.username) {
                authorName = post.full_name || post.username || 'Người dùng';
                if (post.avatar_url) {
                    authorAvatar = post.avatar_url.startsWith('http') ? post.avatar_url : `${API_URL}${post.avatar_url}`;
                }
            }
            
            console.log('Final author name:', authorName);
            console.log('Final author avatar:', authorAvatar);
            
            document.getElementById('postAuthorName').textContent = authorName;
            document.getElementById('postAuthorAvatar').src = authorAvatar;
            
            // Fix date handling
            const timeText = post.created_at ? getTimeAgo(post.created_at) : 'Không rõ thời gian';
            console.log('Time text:', timeText);
            document.getElementById('postTime').textContent = timeText;

            // Content
            const contentEl = document.getElementById('postTextContent');
            if (post.content) {
                contentEl.textContent = post.content;
                contentEl.classList.remove('hidden');
            } else {
                contentEl.classList.add('hidden');
            }

            // Media
            const mediaContainer = document.getElementById('postMediaContainer');
            const mediaImage = document.getElementById('postImage');
            const mediaVideo = document.getElementById('postVideo');
            
            if (post.media && post.media.length > 0) {
                const firstMedia = post.media[0];
                const mediaUrl = firstMedia.media_url.startsWith('http') ? firstMedia.media_url : `${API_URL}${firstMedia.media_url}`;
                
                console.log('Media URL:', mediaUrl);
                console.log('Media type:', firstMedia.media_type);
                
                mediaContainer.classList.remove('hidden');
                
                if (firstMedia.media_type === 'video') {
                    mediaVideo.src = mediaUrl;
                    mediaVideo.classList.remove('hidden');
                    mediaImage.classList.add('hidden');
                } else {
                    mediaImage.src = mediaUrl;
                    mediaImage.classList.remove('hidden');
                    mediaVideo.classList.add('hidden');
                    
                    // Error handler for images
                    mediaImage.onerror = () => {
                        console.error('Failed to load image:', mediaUrl);
                        mediaImage.classList.add('hidden');
                        mediaContainer.classList.add('hidden');
                    };
                }
            } else {
                mediaContainer.classList.add('hidden');
            }

            // Stats
            document.getElementById('likeCount').textContent = `${post.like_count || 0} lượt thích`;
            document.getElementById('commentCount').textContent = `${post.comment_count || 0} bình luận`;

            // Like button
            const likeButton = document.getElementById('likeButton');
            const likeIcon = likeButton.querySelector('.material-symbols-outlined');
            if (post.is_liked) {
                likeIcon.classList.remove('material-symbols-outlined');
                likeIcon.classList.add('material-symbols-outlined-filled');
                likeButton.classList.add('text-red-500');
            }
        }


        // Toggle like
        async function toggleLike() {
            if (!currentPostId) return;
            
            try {
                const response = await fetchWithAuth(`${API_URL}/posts/${currentPostId}/like`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    await loadPost(currentPostId);
                }
            } catch (error) {
                console.error('Error toggling like:', error);
            }
        }

        // Load comments
        async function loadComments(postId) {
            try {
                const response = await fetchWithAuth(`${API_URL}/posts/${postId}/comments`);
                if (!response.ok) throw new Error('Không thể tải bình luận');
                
                const data = await response.json();
                console.log('=== RAW COMMENTS DATA FROM API ===');
                console.log(JSON.stringify(data, null, 2));
                console.log('=== END COMMENTS DATA ===');
                
                // Handle different response structures
                let comments = [];
                if (Array.isArray(data)) {
                    comments = data;
                } else if (data.comments && Array.isArray(data.comments)) {
                    comments = data.comments;
                } else if (data.data && Array.isArray(data.data)) {
                    comments = data.data;
                }
                
                console.log('Parsed comments array, length:', comments.length);
                if (comments.length > 0) {
                    console.log('First comment structure:', comments[0]);
                }
                
                renderComments(comments);
            } catch (error) {
                console.error('Error loading comments:', error);
                document.getElementById('commentsList').innerHTML = `
                    <div class="p-8 text-center text-red-500">
                        <span class="material-symbols-outlined text-5xl">error</span>
                        <p class="mt-2">Không thể tải bình luận</p>
                    </div>
                `;
            }
        }

        // Render comments
        function renderComments(comments) {
            const container = document.getElementById('commentsList');
            
            if (comments.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center text-[#5e8d89]">
                        <span class="material-symbols-outlined text-5xl">chat_bubble_outline</span>
                        <p class="mt-2">Chưa có bình luận nào</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = comments.map(comment => renderComment(comment)).join('');
        }

        // Render single comment - ACCESS NESTED AUTHOR OBJECT
        function renderComment(comment) {
            console.log('=== RENDERING COMMENT ===');
            console.log('Comment keys:', Object.keys(comment));
            console.log('Comment.author:', comment.author);
            console.log('Comment.user:', comment.user);
            console.log('Comment.username:', comment.username);
            console.log('Comment.full_name:', comment.full_name);
            
            // Try different possible data structures
            let authorName = 'Người dùng';
            let authorAvatar = 'images/default-avatar.png';
            
            // Check nested author object first
            if (comment.author) {
                authorName = comment.author.full_name || comment.author.username || 'Người dùng';
                if (comment.author.avatar_url) {
                    authorAvatar = comment.author.avatar_url.startsWith('http') ? comment.author.avatar_url : `${API_URL}${comment.author.avatar_url}`;
                }
            }
            // Check nested user object
            else if (comment.user) {
                authorName = comment.user.full_name || comment.user.username || 'Người dùng';
                if (comment.user.avatar_url) {
                    authorAvatar = comment.user.avatar_url.startsWith('http') ? comment.user.avatar_url : `${API_URL}${comment.user.avatar_url}`;
                }
            }
            // Check flat structure
            else if (comment.full_name || comment.username) {
                authorName = comment.full_name || comment.username || 'Người dùng';
                if (comment.avatar_url) {
                    authorAvatar = comment.avatar_url.startsWith('http') ? comment.avatar_url : `${API_URL}${comment.avatar_url}`;
                }
            }
            
            const timeAgo = comment.created_at ? getTimeAgo(comment.created_at) : 'Không rõ thời gian';
            
            console.log('Final comment author:', authorName);
            console.log('Final comment avatar:', authorAvatar);
            console.log('Comment time:', timeAgo);
            
            let mediaHTML = '';
            if (comment.media_url) {
                const mediaUrl = comment.media_url.startsWith('http') ? comment.media_url : `${API_URL}${comment.media_url}`;
                if (comment.media_type === 'video') {
                    mediaHTML = `<video src="${mediaUrl}" controls class="mt-2 max-h-48 rounded-lg border border-[#dae7e6]"></video>`;
                } else {
                    mediaHTML = `<img src="${mediaUrl}" class="mt-2 max-h-48 rounded-lg border border-[#dae7e6] cursor-pointer" onclick="openImageModal('${mediaUrl}')" onerror="this.style.display='none'" />`;
                }
            }

            const likeIcon = comment.is_liked ? 'favorite' : 'favorite_border';
            const likeColor = comment.is_liked ? 'text-red-500' : 'text-[#5e8d89]';

            // Get current user avatar for reply form
            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
            const currentUserAvatar = currentUser.avatar_url ? `${API_URL}${currentUser.avatar_url}` : 'images/default-avatar.png';

            return `
                <div class="p-4 border-b border-[#dae7e6] dark:border-[#2a3d3b] hover:bg-[#e8f1f0] dark:hover:bg-[#1a332f] transition-colors">
                    <div class="flex gap-3">
                        <img src="${authorAvatar}" class="size-10 rounded-full border-2 border-[#dae7e6] shrink-0 object-cover" onerror="this.src='images/default-avatar.png'" />
                        <div class="flex-1">
                            <div class="bg-[#e8f1f0] dark:bg-[#1a332f] rounded-2xl px-4 py-3">
                                <p class="font-bold text-[#101818] dark:text-white text-sm">${authorName}</p>
                                <p class="text-[#101818] dark:text-white text-sm mt-1 whitespace-pre-wrap">${comment.content}</p>
                                ${mediaHTML}
                            </div>
                            <div class="flex items-center gap-4 mt-2 ml-2">
                                <button onclick="toggleCommentLike(${comment.id})" class="flex items-center gap-1 text-xs font-medium ${likeColor} hover:underline">
                                    <span class="material-symbols-outlined text-sm">${likeIcon}</span>
                                    <span>${comment.like_count || 0} Thích</span>
                                </button>
                                <button onclick="showReplyForm(${comment.id})" class="text-xs font-medium text-[#5e8d89] dark:text-[#8faeaa] hover:underline">
                                    Trả lời
                                </button>
                                <span class="text-xs text-[#5e8d89] dark:text-[#8faeaa]">${timeAgo}</span>
                            </div>
                            
                            <!-- Reply Form -->
                            <div id="replyForm-${comment.id}" class="mt-3 ml-4 hidden">
                                <div class="flex items-start gap-2">
                                    <img src="${currentUserAvatar}" class="size-8 rounded-full border-2 border-[#dae7e6] shrink-0 object-cover" onerror="this.src='images/default-avatar.png'" />
                                    <div class="flex-1">
                                        <textarea id="replyInput-${comment.id}" placeholder="Viết trả lời..." class="w-full px-3 py-2 rounded-lg border border-[#dae7e6] dark:border-[#2a3d3b] bg-white dark:bg-[#152a28] text-[#101818] dark:text-white text-sm placeholder:text-[#5e8d89] focus:outline-none focus:border-primary resize-none" rows="2"></textarea>
                                        <div class="flex items-center justify-end gap-2 mt-2">
                                            <button onclick="hideReplyForm(${comment.id})" class="px-3 py-1 text-sm text-[#5e8d89] hover:bg-[#e8f1f0] rounded-lg transition-colors">
                                                Hủy
                                            </button>
                                            <button onclick="submitReply(${comment.id})" class="px-4 py-1 text-sm bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                                Gửi
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Replies -->
                            <div id="replies-${comment.id}" class="mt-3 ml-4 space-y-3">
                                ${(comment.replies || []).map(reply => renderReply(reply)).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render reply - ACCESS NESTED AUTHOR OBJECT
        function renderReply(reply) {
            console.log('=== RENDERING REPLY ===');
            console.log('Reply keys:', Object.keys(reply));
            console.log('Reply.author:', reply.author);
            console.log('Reply.user:', reply.user);
            
            // Try different possible data structures
            let authorName = 'Người dùng';
            let authorAvatar = 'images/default-avatar.png';
            
            // Check nested author object first
            if (reply.author) {
                authorName = reply.author.full_name || reply.author.username || 'Người dùng';
                if (reply.author.avatar_url) {
                    authorAvatar = reply.author.avatar_url.startsWith('http') ? reply.author.avatar_url : `${API_URL}${reply.author.avatar_url}`;
                }
            }
            // Check nested user object
            else if (reply.user) {
                authorName = reply.user.full_name || reply.user.username || 'Người dùng';
                if (reply.user.avatar_url) {
                    authorAvatar = reply.user.avatar_url.startsWith('http') ? reply.user.avatar_url : `${API_URL}${reply.user.avatar_url}`;
                }
            }
            // Check flat structure
            else if (reply.full_name || reply.username) {
                authorName = reply.full_name || reply.username || 'Người dùng';
                if (reply.avatar_url) {
                    authorAvatar = reply.avatar_url.startsWith('http') ? reply.avatar_url : `${API_URL}${reply.avatar_url}`;
                }
            }
            
            const timeAgo = reply.created_at ? getTimeAgo(reply.created_at) : 'Không rõ thời gian';

            console.log('Final reply author:', authorName);
            console.log('Final reply avatar:', authorAvatar);
            console.log('Reply time:', timeAgo);

            const likeIcon = reply.is_liked ? 'favorite' : 'favorite_border';
            const likeColor = reply.is_liked ? 'text-red-500' : 'text-[#5e8d89]';

            return `
                <div class="flex gap-2">
                    <img src="${authorAvatar}" class="size-8 rounded-full border-2 border-[#dae7e6] shrink-0 object-cover" onerror="this.src='images/default-avatar.png'" />
                    <div class="flex-1">
                        <div class="bg-[#e8f1f0] dark:bg-[#1a332f] rounded-2xl px-3 py-2">
                            <p class="font-bold text-[#101818] dark:text-white text-xs">${authorName}</p>
                            <p class="text-[#101818] dark:text-white text-xs mt-1 whitespace-pre-wrap">${reply.content}</p>
                        </div>
                        <div class="flex items-center gap-3 mt-1 ml-2">
                            <button onclick="toggleCommentLike(${reply.id})" class="flex items-center gap-1 text-xs font-medium ${likeColor} hover:underline">
                                <span class="material-symbols-outlined text-xs">${likeIcon}</span>
                                <span>${reply.like_count || 0}</span>
                            </button>
                            <span class="text-xs text-[#5e8d89] dark:text-[#8faeaa]">${timeAgo}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Handle comment media
        function handleCommentMedia(event) {
            const file = event.target.files[0];
            if (!file) return;

            const maxSize = file.type.startsWith('video/') ? 50 * 1024 * 1024 : 5 * 1024 * 1024;
            if (file.size > maxSize) {
                alert(`Kích thước file quá lớn. Tối đa ${file.type.startsWith('video/') ? '50MB' : '5MB'}`);
                return;
            }

            commentMediaFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('commentMediaImg').src = e.target.result;
                document.getElementById('commentMediaPreview').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        // Remove comment media
        function removeCommentMedia() {
            commentMediaFile = null;
            document.getElementById('commentMediaInput').value = '';
            document.getElementById('commentMediaPreview').classList.add('hidden');
        }

        // Submit comment
        async function submitComment() {
            const content = document.getElementById('commentInput').value.trim();
            if (!content && !commentMediaFile) return;

            try {
                let mediaUrl = null;
                if (commentMediaFile) {
                    const formData = new FormData();
                    formData.append('media', commentMediaFile);
                    
                    const uploadResponse = await fetchWithAuth(`${API_URL}/posts/comments/upload-media`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (uploadResponse.ok) {
                        const data = await uploadResponse.json();
                        mediaUrl = data.media_url;
                    }
                }

                const response = await fetchWithAuth(`${API_URL}/posts/${currentPostId}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, media_url: mediaUrl })
                });

                if (response.ok) {
                    document.getElementById('commentInput').value = '';
                    removeCommentMedia();
                    await loadComments(currentPostId);
                    await loadPost(currentPostId);
                }
            } catch (error) {
                console.error('Error submitting comment:', error);
                alert('Không thể gửi bình luận');
            }
        }

        // Toggle comment like
        async function toggleCommentLike(commentId) {
            try {
                const response = await fetchWithAuth(`${API_URL}/posts/comments/${commentId}/like`, {
                    method: 'POST'
                });
                if (response.ok) {
                    await loadComments(currentPostId);
                }
            } catch (error) {
                console.error('Error toggling comment like:', error);
            }
        }

        // Show reply form
        function showReplyForm(commentId) {
            const form = document.getElementById(`replyForm-${commentId}`);
            form.classList.toggle('hidden');
            if (!form.classList.contains('hidden')) {
                document.getElementById(`replyInput-${commentId}`).focus();
            }
        }

        // Hide reply form
        function hideReplyForm(commentId) {
            document.getElementById(`replyForm-${commentId}`).classList.add('hidden');
            document.getElementById(`replyInput-${commentId}`).value = '';
        }

        // Submit reply
        async function submitReply(parentCommentId) {
            const content = document.getElementById(`replyInput-${parentCommentId}`).value.trim();
            if (!content) return;

            try {
                const response = await fetchWithAuth(`${API_URL}/posts/${currentPostId}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, parent_comment_id: parentCommentId })
                });

                if (response.ok) {
                    hideReplyForm(parentCommentId);
                    await loadComments(currentPostId);
                    await loadPost(currentPostId);
                }
            } catch (error) {
                console.error('Error submitting reply:', error);
                alert('Không thể gửi trả lời');
            }
        }

        // Image modal functions
        function openImageModal(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            currentPostId = getPostIdFromURL();
            
            if (!currentPostId) {
                document.getElementById('loadingState').innerHTML = `
                    <div class="text-center">
                        <span class="material-symbols-outlined text-5xl text-red-500">error</span>
                        <p class="mt-4 text-[#101818] dark:text-white font-medium">Không tìm thấy bài viết</p>
                        <button onclick="window.location.href='index.html'" class="mt-4 px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                            Về trang chủ
                        </button>
                    </div>
                `;
                return;
            }

            loadUserAvatar();
            await loadPost(currentPostId);
            await loadComments(currentPostId);
        });
    </script>
</body>

</html>